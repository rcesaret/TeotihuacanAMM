---
title: "Teotihuacan AMM, Script #3:"
subtitle: "Analysis"
author: "Rudolf Cesaretti"
date: "Last run on `r Sys.Date()`"
output:
  html_document:
    toc: true
    df_print: paged
    number_sections: true
---


```{r, setup, include=FALSE,echo=FALSE, message=FALSE,warning=FALSE}
require(knitr)
# Set so that long lines in R will be wrapped:
opts_chunk$set(tidy.opts=list(width.cutoff=75),tidy=TRUE)
#
rm(list = ls())
```


  
# Setup 

All of the data and scripts are downloadable from the [new Teotihuacan AMM Analysis github repository](https://https://github.com/rcesaret/TeotihuacanAMM), which can be cloned to your own account/computer or downloaded directly as a .zip folder.

Either way, once you have done so, you will need to modify the working directory (setwd("C:/...)") path and "dir" variables in the code chunk below to match the repository location on your computer.

```{r, label='Set Local Directory Location', message=FALSE, warning=FALSE}

wd <- list()

#SET YOUR LOCAL DIRECTORY LOCATION HERE:
#wd$dir <- "C:/Users/rcesaret/Dropbox (ASU)/TeotihuacanDean/TeotihuacanAMM/"
wd$dir <- "C:/Users/TJ McMote/Dropbox (ASU)/TeotihuacanDean/TeotihuacanAMM/"

wd$analysis <- paste0(wd$dir,"analysis/")
wd$data_r <- paste0(wd$dir,"data-raw/")
wd$data_p <- paste0(wd$dir,"data-processed/")
wd$data_f <- paste0(wd$dir,"data-final-outputs/")
wd$figs <- paste0(wd$dir,"figures/")
wd$funcs <- paste0(wd$dir,"functions/")

```



## Load R Packages and Custom Functions




```{r, label='Load Libraries', message=FALSE,warning=FALSE}
# Package names
packages <- c("rgdal", "rgeos", "sp", "sf", "GISTools", "raster","stars", "spatstat",
              "tidyverse", "tidyr", "nls.multstart", "nlme", "brms", "broom", 
              "ggrepel", "minpack.lm", "data.table", "zoo", "lmtest", "sandwich", 
              "nlstools", "MASS", "NSM3", "gridExtra", "ggnewscale", "cowplot", 
              "scales", "viridis", "Cairo", "SpatialAcc","geodist", "REAT")

# Install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# load packages
invisible(lapply(packages, library, character.only = TRUE))

rm(packages,installed_packages)

#Read in custom R functions located in the wd$funcs directory folder
FUNCS <- list("RegressionResultsTab.R", "ModelPredFrame.R")
invisible(lapply(FUNCS, function(x) source(paste0(wd$funcs,x))))
rm(FUNCS)

```





## Import Data


```{r, label='Import Data', message=FALSE, warning=FALSE, results = 'hide'}

#TeoRings <- read.csv(paste0(wd$data_f,"TeoRings_Circ.csv"))
TeoRings <- read.csv(paste0(wd$data_f,"TeoRings_Oval.csv"))

#TMP Architecture polygons
Teo_ArchPoly_Data <- invisible(readOGR(paste0(wd$data_f,"Teo_ArchPoly_Data.gpkg")))

#TMP Rings -- Orig, repositioned, rectangular
#RingsPoly <- invisible(readOGR(paste0(wd$data_r,"RingsPoly_Circle.gpkg")))
RingsPoly <- invisible(readOGR(paste0(wd$data_r,"RingsPoly_Oval.gpkg")))

#TMP survey limit polygon
TMP_MapPoly <- invisible(readOGR(paste0(wd$data_r,"TMP_Map_Poly_Extent.gpkg")))

#UrbanOpenPoly <- invisible(readOGR(paste0(wd$data_r,"UrbanOpenPoly.gpkg")))
RuralOpenPoly <- invisible(readOGR(paste0(wd$data_r,"RuralOpenPoly.gpkg")))

CentralLine <- readOGR(paste0(wd$data_r,"CentralLine.gpkg"))

Teo_ArchPoly_Data <- readOGR(paste0(wd$data_f,"Teo_ArchPoly_Data.gpkg"))

```



```{r}

```

Oztoyahualco A17 534.92 3 178.31 15.90 –
La Ventille frente 3 A9 2,673.04 13 205.62 18.70 –
Tlamimilolpa A4 3,534.86 17 207.93 27.30 –
Xolalpan A1 1,120.53 5 224.11 58.00 Figure 4
Tetitla A2 3,821.10 9 424.57 49.20 Figure 4
Atetelco A13 2,995.00 5 599.00 54.49 –
Yayahuala A3 3,619.11 6 603.19 58.40 –
Zacaula Palace A5 3,576.37 4 894.09 42.10








# Gini


$$
A_{j}=\sum_{i=1}^{n} \left( \frac{W_{i}}{D_{ji}} \right)
$$

Teo_ArchPoly_Data@data %>% filter(XM_Low_bi == 1) %>% summarize(m = median(Area_m2)
```{r}

CentralLine.sf <- st_as_sf(CentralLine)
Teo_ArchPoly_Data.sf <- st_as_sf(Teo_ArchPoly_Data)

cen = st_centroid(Teo_ArchPoly_Data.sf)
cen_sp <- as(cen, "Spatial")

x = pointDistance(cen_sp@coords, lonlat = F, allpairs = T)
rownames(x) <- cen_sp@data$ID
colnames(x) <- Teo_ArchPoly_Data@data$ID
z = Teo_ArchPoly_Data@data %>% select(ID,Area_m2,XM_group_f) %>% filter(XM_group_f == "AoD" | XM_group_f == "CCFeat")
x2 = x[ , colnames(x) %in% z$ID]

ac1 <- t(z$Area_m2/t(x2^1))
ac1 <- apply(ac1, 1, sum)
ac1 <- scales::rescale(ac1)
#hist(ac1)

ac2 <- t(z$Area_m2/t(x2^0.5))
ac2 <- apply(ac2, 1, sum)
ac2 <- scales::rescale(ac2)

ac3 <- t(z$Area_m2/t(x2^0.33))
ac3 <- apply(ac3, 1, sum)
ac3 <- scales::rescale(ac3)

ac4 <- t(z$Area_m2/t(x2^0.2))
ac4 <- apply(ac4, 1, sum)
ac4 <- scales::rescale(ac4)

ac5 <- t(z$Area_m2/t(x2^1.5))
ac5 <- apply(ac5, 1, sum)
ac5 <- scales::rescale(ac5)

cen$ac1 = ac1
cen$ac2 = ac2
cen$ac3 = ac3
cen$ac4 = ac4
cen$ac5 = ac5
plot(cen["ac1"])

cen$DistLine = as.numeric(st_distance(cen, CentralLine.sf))
cen$InvDistLine = 1/cen$DistLine
cen = cen %>% filter(XM_macro_DStr_bi == 1) %>% 
  mutate(AreaPerPerson = ifelse(XM_High_bi == 1, 142.1237, ifelse(XM_Low_bi == 1, 8.027818, 43.82432)),###
         Dwellings = ifelse(XM_High_bi == 1, 142.1237, ifelse(XM_Low_bi == 1, 9.3752, 43.82432)),
         Wealth_Pop = XM_Pop*AreaPerPerson,
         Wealth_Pop_perArea = XM_Pop*AreaPerPerson/Area_m2,
         Wealth_Pop_div = AreaPerPerson/XM_Pop,
         Wealth_Area = Area_m2*AreaPerPerson,
         Wealth_Area_HH = Wealth_Area/XM_DwellingUnits,
         Wealth_Area_Pers = Wealth_Area/XM_Pop,
         PropVal_DStr_InvDist = InvDistLine*Area_m2,
         PropVal_HH_InvDist = PropVal_DStr_InvDist/XM_DwellingUnits,
         PropVal_Pers_InvDist = PropVal_DStr_InvDist/XM_Pop,###
         PropVal_DStr_InvDistClass = InvDistLine*Area_m2*AreaPerPerson,
         PropVal_HH_InvDistClass = PropVal_DStr_InvDistClass/XM_DwellingUnits,
         PropVal_Pers_InvDistClass = PropVal_DStr_InvDistClass/XM_Pop,
         PropVal_DStr_Acc = ac1*Area_m2,
         PropVal_HH_Acc = PropVal_DStr_InvDistClass/XM_DwellingUnits,
         PropVal_Pers_Acc = PropVal_DStr_InvDistClass/XM_Pop,
         PropVal_DStr_AccClass = ac1*Area_m2*AreaPerPerson,
         PropVal_HH_AccClass = PropVal_DStr_InvDistClass/XM_DwellingUnits,
         PropVal_Pers_AccClass = PropVal_DStr_InvDistClass/XM_Pop)


```







```{r}
gini(cen$Area_m2, lc = TRUE, lsize = 2, le.col = "black", lc.col = "darkorange", lcx = "Cumulative Shares of Population (HH or DStr)", lcy = "Cumulative Shares of Wealth Proxies", lctitle = "Teotihuacan Gini Indicies for Wealth Proxies", lcg = TRUE, lcgn = F, lcg.caption =  "1) Domestic Structure (DStr) Area:", lcg.lab.x = 0, lcg.lab.y = 1) 

gini(cen$PropVal_DStr_InvDist, lc = TRUE, lsize = 2, add.lc = TRUE,  lc.col = "firebrick", lcg = TRUE, lcgn = F, lcg.caption =  "2) DStr Property Value (PropVal):", lcg.lab.x = 0, lcg.lab.y = 0.875)

gini(cen$PropVal_DStr_InvDistClass, lc = TRUE, lsize = 2, add.lc = TRUE,  lc.col = "purple", lcg = TRUE, lcgn = F, lcg.caption =  "3) DStr Class PropVal:", lcg.lab.x = 0, lcg.lab.y = 0.75) 

gini(cen$PropVal_HH_InvDist, lc = TRUE, lsize = 2, add.lc = TRUE,  lc.col = "blue", lcg = TRUE, lcgn = F, lcg.caption =  "4) Household (HH) PropVal:", lcg.lab.x = 0, lcg.lab.y = 0.625)

gini(cen$PropVal_HH_InvDistClass, lc = TRUE, lsize = 2, add.lc = TRUE,  lc.col = "green3", lcg = TRUE, lcgn = F, lcg.caption =  "5) HH Class PropVal:", lcg.lab.x = 0, lcg.lab.y = 0.5)

gini(cen$Wealth_Area_HH, lc = TRUE, lsize = 2, add.lc = TRUE,  lc.col = "cyan3", lcg = TRUE, lcgn = F, lcg.caption =  "6) Wealth_Area_HH:", lcg.lab.x = 0, lcg.lab.y = 0.4)


```





```{r}

gini(cen$Area_m2, lc = TRUE, lsize = 2, le.col = "black", lc.col = "darkorange", lcx = "Cumulative Shares of Population (HH or DStr)", lcy = "Cumulative Shares of Wealth Proxies", lctitle = "Teotihuacan Gini Indicies for Wealth Proxies", lcg = TRUE, lcgn = F, lcg.caption =  "1) Domestic Structure (DStr) Area:", lcg.lab.x = 0, lcg.lab.y = 1)
gini(cen$Wealth_Area_Pers, lc = TRUE, lsize = 2, add.lc = TRUE,  lc.col = "yellow2", lcg = TRUE, lcgn = F, lcg.caption =  "7) Wealth_Area_Pers:", lcg.lab.x = 0, lcg.lab.y = 0.3)
gini(cen$Wealth_Area, lc = TRUE, lsize = 2, add.lc = TRUE,  lc.col = "grey50", lcg = TRUE, lcgn = F, lcg.caption =  "8) Wealth_Area:", lcg.lab.x = 0, lcg.lab.y = 0.2)
gini(cen$PropVal_Pers_InvDist, lc = TRUE, lsize = 2, add.lc = TRUE,  lc.col = "red", lcg = TRUE, lcgn = F, lcg.caption =  "9) PropVal_Pers_InvDist:", lcg.lab.x = 0.5, lcg.lab.y = 1)
gini(cen$PropVal_Pers_InvDistClass, lc = TRUE, lsize = 2, add.lc = TRUE,  lc.col = "pink", lcg = TRUE, lcgn = F, lcg.caption =  "10) PropVal_Pers_InvDistClass:", lcg.lab.x = 0.5, lcg.lab.y = 0.85)
gini(cen$Wealth_Pop_div, lc = TRUE, lsize = 2, add.lc = TRUE,  lc.col = "orange", lcg = TRUE, lcgn = F, lcg.caption =  "11) Wealth_Pop_div:", lcg.lab.x = 0.5, lcg.lab.y = 0.75)
#gini(cen$AreaPerPerson, lc = TRUE, lsize = 2, add.lc = TRUE,  lc.col = "red", lcg = TRUE, lcgn = TRUE, lcg.caption =  "Area per Person", lcg.lab.x = 0, lcg.lab.y = 0.85)  
#gini(cen$Wealth_Area, lc = TRUE, lsize = 2, add.lc = TRUE,  lc.col = "blue", lcg = TRUE, lcgn = F, lcg.caption =  "Area per Person * Area:", lcg.lab.x = 0, lcg.lab.y = 0.9) 
#gini(cen$Wealth_Pop, lc = TRUE, lsize = 1, add.lc = TRUE,  lc.col = "purple", lcg = TRUE, lcgn = TRUE, lcg.caption =  "Area per Person * Pop:", lcg.lab.x = 0, lcg.lab.y = 0.55)
#ggsave("Ginis.png", plot = last_plot(), device = "png", path = wd$figs, scale = 1, width = 675, height = 675,   units = "px",  dpi = 1000, bg = "white")
```



PropVal_DStr_Acc = ac1*Area_m2,
         PropVal_HH_Acc = PropVal_DStr_InvDistClass/XM_DwellingUnits,
         PropVal_Pers_Acc = PropVal_DStr_InvDistClass/XM_Pop,
         PropVal_DStr_AccClass = ac1*Area_m2*AreaPerPerson,
         PropVal_HH_AccClass = PropVal_DStr_InvDistClass/XM_DwellingUnits,
         PropVal_Pers_AccClass = PropVal_DStr_InvDistClass/XM_Pop


```{r}
gini(cen$Area_m2, lc = TRUE, lsize = 2, le.col = "black", lc.col = "darkorange", lcx = "Cumulative Shares of Population (HH or DStr)", lcy = "Cumulative Shares of Wealth Proxies", lctitle = "Teotihuacan Gini Indicies for Wealth Proxies", lcg = TRUE, lcgn = F, lcg.caption =  "1) Domestic Structure (DStr) Area:", lcg.lab.x = 0, lcg.lab.y = 1)  
gini(cen$PropVal_DStr_Acc, lc = TRUE, lsize = 2, add.lc = TRUE,  lc.col = "firebrick", lcg = TRUE, lcgn = F, lcg.caption =  "2) PropVal_DStr_Acc:", lcg.lab.x = 0, lcg.lab.y = 0.875)
gini(cen$PropVal_HH_Acc, lc = TRUE, lsize = 2, add.lc = TRUE,  lc.col = "purple", lcg = TRUE, lcgn = F, lcg.caption =  "3) PropVal_HH_Acc:", lcg.lab.x = 0, lcg.lab.y = 0.75) 
gini(cen$PropVal_Pers_Acc, lc = TRUE, lsize = 2, add.lc = TRUE,  lc.col = "blue", lcg = TRUE, lcgn = F, lcg.caption =  "4) PropVal_Pers_Acc:", lcg.lab.x = 0, lcg.lab.y = 0.625)
gini(cen$PropVal_DStr_AccClass, lc = TRUE, lsize = 2, add.lc = TRUE,  lc.col = "green3", lcg = TRUE, lcgn = F, lcg.caption =  "5) PropVal_DStr_AccClass:", lcg.lab.x = 0, lcg.lab.y = 0.5)
gini(cen$PropVal_HH_AccClass, lc = TRUE, lsize = 2, add.lc = TRUE,  lc.col = "cyan3", lcg = TRUE, lcgn = F, lcg.caption =  "6) PropVal_HH_AccClass:", lcg.lab.x = 0, lcg.lab.y = 0.4)
gini(cen$PropVal_Pers_AccClass, lc = TRUE, lsize = 2, add.lc = TRUE,  lc.col = "yellow2", lcg = TRUE, lcgn = F, lcg.caption =  "7) PropVal_Pers_AccClass:", lcg.lab.x = 0, lcg.lab.y = 0.3)

```

```{r}
gini(cen$Area_m2, lc = TRUE, lsize = 2, le.col = "black", lc.col = "darkorange", lcx = "Cumulative Shares of Population (HH or DStr)", lcy = "Cumulative Shares of Wealth Proxies", lctitle = "Teotihuacan Gini Indicies for Wealth Proxies", lcg = TRUE, lcgn = F, lcg.caption =  "1) Domestic Structure (DStr) Area:", lcg.lab.x = 0, lcg.lab.y = 1)  
gini(cen$ac1, lc = TRUE, lsize = 2, add.lc = TRUE,  lc.col = "firebrick", lcg = TRUE, lcgn = F, lcg.caption =  "2) ac1:", lcg.lab.x = 0, lcg.lab.y = 0.875)
gini(cen$ac2, lc = TRUE, lsize = 2, add.lc = TRUE,  lc.col = "purple", lcg = TRUE, lcgn = F, lcg.caption =  "3) ac2:", lcg.lab.x = 0, lcg.lab.y = 0.75) 
gini(cen$ac3, lc = TRUE, lsize = 2, add.lc = TRUE,  lc.col = "blue", lcg = TRUE, lcgn = F, lcg.caption =  "4) ac3:", lcg.lab.x = 0, lcg.lab.y = 0.625)
gini(cen$ac4, lc = TRUE, lsize = 2, add.lc = TRUE,  lc.col = "green3", lcg = TRUE, lcgn = F, lcg.caption =  "5) ac4:", lcg.lab.x = 0, lcg.lab.y = 0.5)
gini(cen$ac5, lc = TRUE, lsize = 2, add.lc = TRUE,  lc.col = "cyan3", lcg = TRUE, lcgn = F, lcg.caption =  "6) ac5:", lcg.lab.x = 0, lcg.lab.y = 0.4)


```

         
```{r}
cen2 = st_drop_geometry(cen)

CenRings = cen2 %>% group_by(Ring_Oval) %>% summarize(
  AreaPerPerson_Avg = mean(AreaPerPerson, na.rm=T),
  AreaPerPerson_Tot = sum(AreaPerPerson, na.rm=T),
  Wealth_Pop_Avg = mean(Wealth_Pop, na.rm=T),
  Wealth_Pop_Tot = sum(Wealth_Pop, na.rm=T),
  Wealth_Pop_perArea_Avg = mean(Wealth_Pop_perArea, na.rm=T),
  Wealth_Pop_perArea_Tot = sum(Wealth_Pop_perArea, na.rm=T),
  Wealth_Pop_div_Avg = mean(Wealth_Pop_div, na.rm=T),
  Wealth_Pop_div_Tot = sum(Wealth_Pop_div, na.rm=T),
  Wealth_Area_Avg = mean(Wealth_Area, na.rm=T),
  Wealth_Area_Tot = sum(Wealth_Area, na.rm=T),
  Wealth_Area_HH_Avg = mean(Wealth_Area_HH, na.rm=T),
  Wealth_Area_HH_Tot = sum(Wealth_Area_HH, na.rm=T),
  Wealth_Area_Pers_Avg = mean(Wealth_Area_Pers, na.rm=T),
  Wealth_Area_Pers_Tot = sum(Wealth_Area_Pers, na.rm=T),
  PropVal_DStr_InvDist_Avg = mean(PropVal_DStr_InvDist, na.rm=T),
  PropVal_DStr_InvDist_Tot = sum(PropVal_DStr_InvDist, na.rm=T),
  PropVal_HH_InvDist_Avg = mean(PropVal_HH_InvDist, na.rm=T),
  PropVal_HH_InvDist_Tot = sum(PropVal_HH_InvDist, na.rm=T),
  PropVal_Pers_InvDist_Avg = mean(PropVal_Pers_InvDist, na.rm=T),
  PropVal_Pers_InvDist_Tot = sum(PropVal_Pers_InvDist, na.rm=T),
  PropVal_DStr_InvDistClass_Avg = mean(PropVal_DStr_InvDistClass, na.rm=T),
  PropVal_DStr_InvDistClass_Tot = sum(PropVal_DStr_InvDistClass, na.rm=T),
  PropVal_HH_InvDistClass_Avg = mean(PropVal_HH_InvDistClass, na.rm=T),
  PropVal_HH_InvDistClass_Tot = sum(PropVal_HH_InvDistClass, na.rm=T),
  PropVal_Pers_InvDistClass_Avg = mean(PropVal_Pers_InvDistClass, na.rm=T),
  PropVal_Pers_InvDistClass_Tot = sum(PropVal_Pers_InvDistClass, na.rm=T),
  PropVal_DStr_Acc_Avg = mean(PropVal_DStr_Acc, na.rm=T),
  PropVal_DStr_Acc_Tot = sum(PropVal_DStr_Acc, na.rm=T),
  PropVal_HH_Acc_Avg = mean(PropVal_HH_Acc, na.rm=T),
  PropVal_HH_Acc_Tot = sum(PropVal_HH_Acc, na.rm=T),
  PropVal_Pers_Acc_Avg = mean(PropVal_Pers_Acc, na.rm=T),
  PropVal_Pers_Acc_Tot = sum(PropVal_Pers_Acc, na.rm=T),
  PropVal_DStr_AccClass_Avg = mean(PropVal_DStr_AccClass, na.rm=T),
  PropVal_DStr_AccClass_Tot = sum(PropVal_DStr_AccClass, na.rm=T),
  PropVal_HH_AccClass_Avg = mean(PropVal_HH_AccClass, na.rm=T),
  PropVal_HH_AccClass_Tot = sum(PropVal_HH_AccClass, na.rm=T),
  PropVal_Pers_AccClass_Avg = mean(PropVal_Pers_AccClass, na.rm=T),
  PropVal_Pers_AccClass_Tot = sum(PropVal_Pers_AccClass, na.rm=T)
) %>% mutate(InvDist = 1/seq(250,(500*9)-250,by=500))

#plot(CenRings$InvDist,CenRings$Wealth_Area_Avg)

write.csv(CenRings, paste0(wd$data_f,"CenRings3.csv"))
```




```{r include=FALSE,echo=F,message=FALSE,warning=FALSE,results = 'hide'}
expfunc <- function(InvDistLine, b1, b2) {
  b1 * exp( b2 * InvDistLine )
}
pwrfunc <- function(InvDistLine, b1, b2) {
  b1 * InvDistLine^b2
}


cen3 = cen2 %>% filter(XM_Low_bi == 0)

#Estimate the model
exp_nls_fit <- nls.multstart::nls_multstart(Wealth_Pop ~ expfunc(InvDistLine, b1, b2),
                             data = cen3,
                             start_lower = c(b1=2000, b2=-10000),
                             start_upper = c(b1=10000, b2=0),
                             iter = 500,
                             supp_errors = "Y")

pwr_nls_fit <- nls.multstart::nls_multstart(Wealth_Pop ~ pwrfunc(InvDistLine, b1, b2),
                             data = cen3,
                             #start_lower = c(b1=2000, b2=-10000),
                             #start_upper = c(b1=10000, b2=0),
                             iter = 3000,
                             supp_errors = "Y")

pp4 = ModelPredFrame(exp_nls_fit,cen3,"InvDistLine","Wealth_Pop")
pp4b = ModelPredFrame(pwr_nls_fit,cen3,"InvDistLine","Wealth_Pop")

pwr_nls_fit_results = RegressionResultsTab(pwr_nls_fit, cen3, cen3$InvDistLine, cen3$Wealth_Pop, model_type="nls", coef="both", residplots=TRUE, residhists=TRUE)

exp_nls_fit_results = RegressionResultsTab(exp_nls_fit, cen3, cen3$InvDistLine, cen3$Wealth_Pop, model_type="nls", coef="both", residplots=TRUE, residhists=TRUE)

pwr_nls_fit_results[[1]]
pwr_nls_fit_results[[2]]
pwr_nls_fit_results[[3]]
exp_nls_fit_results[[1]]
exp_nls_fit_results[[2]]
exp_nls_fit_results[[3]]

```



InvDistLine, cen3$Wealth_Pop
```{r echo=FALSE,message=FALSE,warning=FALSE}

ggplot() +
  geom_point(data = cen3, aes(x = (InvDistLine), y = (Wealth_Pop)), size=2.5, color="black", shape=16, stroke =2)+
  #geom_smooth(method = lm, se = FALSE,color="green3", size=1.3)
  geom_line(data = pp4b, aes(x=InvDistLine, y=Wealth_Pop.p), inetype = "solid", color="red", size=1.3) +
  #geom_text_repel(data = TeoRings, aes(x = MedRingDist, y = Popdens_TOT, xmin = MinRingDist, xmax = MaxRingDist, label=Ring), size=4,direction="y", fontface="bold", nudge_y=2, point.size=5) +#box.padding=1, 
  #geom_text_repel(box.padding=1,size=5,fontface="bold", nudge_y=1.5) +# 


  #geom_point(data = TeoRings %>% filter(Ring > 1), aes(x = MedRingDist, y = Popdens_TOT, xmin = MinRingDist, xmax = MaxRingDist, label=Ring), size=2.5, color="black", shape=16, stroke =2)+
  #geom_point(data = TeoRings %>% filter(Ring < 2), aes(x = MedRingDist, y = Popdens_TOT), size=3, color="red2", shape=4, stroke =2)+
  #annotate("label", x = 0.15, y = 0.8, label = "atop(bold(italic(PctOpen) == 0.914 * ~italic(PctCCFeat) ^ (-5.388)),bold(italic(pseudo~R^2) == 0.771 ~~~~~~ italic(n) == 9 ))", parse = TRUE, color ="black", size=4)+
  #ggtitle("Total Population Density Gradient for 500-meter Concentric Rings", subtitle= "Teotihuacan, Xolalpan-Metepec Phase (c. AD 350-600)") +
  #xlab("Percent CC Feature Area in Ring") +
  #ylab("Percent Open Area in Ring") +
  theme_bw() + coord_trans(x="log2", y="log2")+
  #scale_y_continuous(labels = scales::percent, limits=c(0.3,1), breaks=seq(0.4,1,0.2)) +
  #scale_x_continuous(labels = scales::percent, limits=c(0,0.25), breaks=seq(0,0.25,0.05)) +
  #scale_y_continuous(expand = c(0, 0), ,) +
  #scale_x_continuous(expand = c(0, 0), limits=c(-20,4600),breaks=seq(0,4000,1000)) +
  theme(plot.title = element_text(size = 14, face = "bold",hjust = 0.5)) +
  theme(plot.subtitle = element_text(size = 12, face = "bold.italic",hjust = 0.5)) +
  theme(axis.text = element_text(size = 12, color="black")) +
  theme(axis.title.y = element_text(size = 14, face = "bold")) +
  theme(axis.title.x = element_text(size = 14, face = "bold"))

```














































# Unused




```{r include=FALSE,echo=F,message=FALSE,warning=FALSE,results = 'hide'}
#Estimate the model
TeoRings <- TeoRings %>% mutate(Log_PctRow_Ring_DStrArea_Low = log(PctRow_Ring_DStrArea_Low))

fit_f5c = lm(Log_PctRow_Ring_DStrArea_Low ~ Log_PctRow_Area_CCFeat_AoD, TeoRings)



predict_f5c = ModelPredFrame(fit_f5c,TeoRings,"Log_PctRow_Area_CCFeat_AoD","Log_PctRow_Ring_DStrArea_Low",unlog_after = T)#, xmin = log(0.002)

results_f5c = RegressionResultsTab(fit_f5c, TeoRings, TeoRings$Log_PctRow_Area_CCFeat_AoD, TeoRings$Log_PctRow_Ring_DStrArea_Low, model_type="ols", coef="both", residplots=F, residhists=F)

RegressionTable$`Figure 5C` <- c("Log CC Feat % Ring Area","Log Low Stat % DStr Area","Log-Log","log(Y) = b2*log(X) + b1",
                    "OLS",paste(round(results_f5c[[1]]$R2,3)), paste(results_f5c[[1]]$n), 
                    #paste(sum(TeoRings$ArchFeat_TOT, na.rm=T), "(ArchFeat)"),
                    paste(sum(TeoRings$CCStr, na.rm=T), "(CCStr);", sum(TeoRings$Low_DStr, na.rm=T), "(Low DStr)"),
paste0(round(results_f5a[[2]]$estimate[[1]],4)," (p < ",round(results_f5a[[2]]$p.value[[1]],4),")"),
paste0(round(results_f5a[[2]]$estimate[[2]],4)," (p < ",round(results_f5a[[2]]$p.value[[2]],4),")"))

```

```{r include=FALSE,echo=F,message=FALSE,warning=FALSE,results = 'hide'}
#Estimate the model
TeoRings <- TeoRings %>% mutate(Log_PctRow_Ring_DStrArea_Low = log(PctRow_Ring_DStrArea_Low))

fit_f5c = lm(Log_PctRow_Area_CCFeat_AoD ~ Log_PctRow_Ring_DStrArea_Low, TeoRings)



predict_f5c = ModelPredFrame(fit_f5c,TeoRings,"Log_PctRow_Ring_DStrArea_Low","Log_PctRow_Area_CCFeat_AoD",unlog_after = T)#

results_f5c = RegressionResultsTab(fit_f5c, TeoRings, TeoRings$Log_PctRow_Ring_DStrArea_Low, TeoRings$Log_PctRow_Area_CCFeat_AoD,  model_type="ols", coef="both", residplots=F, residhists=F)

RegressionTable$`Figure 5C` <- c("Log Low Stat % DStr Area","Log CC Feat % Ring Area","Log-Log","log(Y) = b2*log(X) + b1",
                    "OLS",paste(round(results_f5a[[1]]$R2,3)), paste(results_f5a[[1]]$n), 
                    #paste(sum(TeoRings$ArchFeat_TOT, na.rm=T), "(ArchFeat)"),
                    paste(sum(TeoRings$CCStr, na.rm=T), "(CCStr);", sum(TeoRings$Low_DStr, na.rm=T), "(Low DStr)"),
paste0(round(results_f5a[[2]]$estimate[[1]],4)," (p < ",round(results_f5a[[2]]$p.value[[1]],4),")"),
paste0(round(results_f5a[[2]]$estimate[[2]],4)," (p < ",round(results_f5a[[2]]$p.value[[2]],4),")"))

```





scales::rescale(c(142.1237,43.82432,9.37519568567026),c(1,2))

Avg_DStrArea_perCapita

# SM


```{r Define simple power function, include=FALSE,echo=F,message=FALSE,warning=FALSE,results = 'hide'}
pwrfunc <- function(PctRow_Ring_DStrArea_Low, b1, b2) {
  b1 * PctRow_Ring_DStrArea_Low^b2
}
pwr_nls_fit <- nls.multstart::nls_multstart(PctRow_Area_CCFeat_AoD ~ pwrfunc(PctRow_Ring_DStrArea_Low, b1, b2),
                             data = TeoRings,
                             start_lower = c(b1=-1, b2=-1),
                             start_upper = c(b1=1, b2=1),
                             iter = 500,
                             supp_errors = "Y")

pp3 = ModelPredFrame(pwr_nls_fit,TeoRings,"PctRow_Ring_DStrArea_Low","PctRow_Area_CCFeat_AoD")



```


```{r echo=FALSE,message=FALSE,warning=FALSE}

f5c <- ggplot() +
  geom_point(data = TeoRings, aes(x = PctRow_Area_CCFeat_AoD, y = PctRow_Ring_DStrArea_Low), size=2.5, color="black", shape=16, stroke =2)+
  geom_line(data = pp3, aes(x=PctRow_Area_CCFeat_AoD.p, y=PctRow_Ring_DStrArea_Low), inetype = "solid", color="red", size=1.3) +
  annotate("label", x = 0.125, y = 0.05, label = "Low Status", color ="red", size=5)+
  annotate("label", x = 0.125, y = 0.04, label = "atop(bold(italic(PctCCFeat) == 0.00000679 ~italic(PctLow) ^ -1.47),bold(italic(pseudo~R^2) == 0.995 ~~~~~~ italic(n) == 9 ))", parse = TRUE, color ="firebrick", size=4)+
  xlab("CC Feat % Ring Area") +
  ylab("% Ring DStr Area") +
  theme_bw() +
  scale_y_continuous(labels = scales::percent) +#, breaks=seq(0.4,1,0.2)
  scale_x_continuous(labels = scales::percent) +#, limits=c(0,0.25), breaks=seq(0,0.25,0.05)
  #scale_y_continuous(expand = c(0, 0), ,) +
  #scale_x_continuous(expand = c(0, 0), limits=c(-20,4600),breaks=seq(0,4000,1000)) +
  theme(plot.title = element_text(size = 14, face = "bold",hjust = 0.5)) +
  theme(plot.subtitle = element_text(size = 12, face = "bold.italic",hjust = 0.5)) +
  theme(axis.text = element_text(size = 12, color="black")) +
  theme(axis.title.y = element_text(size = 14, face = "bold")) +
  theme(axis.title.x = element_text(size = 14, face = "bold"))

f5c
```

```{r echo=FALSE,message=FALSE,warning=FALSE}

f6a <- ggplot() +
  geom_errorbarh(data = TeoRings, aes(x = MedRingDist, y = Avg_Area_DStr, xmin = MinRingDist, xmax = MaxRingDist, label=Ring),height=25, size=1) +
  geom_line(data = TeoRings, aes(x=MedRingDist, y=Avg_Area_DStr), inetype = "solid", color="firebrick", size=1.3) +
  geom_point(data = TeoRings, aes(x = MedRingDist, y = Avg_Area_DStr, xmin = MinRingDist, xmax = MaxRingDist, label=Ring), size=2.5, color="black", shape=16, stroke =2)+
  annotate("label", x = 3000, y = 1850, label = "Avg. Domestic Structure Area", color ="firebrick", size=5)+
  xlab("Distance from Center (km)") +
  ylab("Avg Dom.Struct. Area (m^2)") +
  theme_bw() +
  
  scale_y_continuous(breaks=seq(600,1800,400)) +
  scale_x_continuous(expand = c(0, 0), limits=c(-20,4600),breaks=seq(0,4000,1000),
                     labels=function(x)x/1000) +
  theme(plot.title = element_text(size = 14, face = "bold",hjust = 0.5)) +
  theme(plot.subtitle = element_text(size = 12, face = "bold.italic",hjust = 0.5)) +
  theme(axis.text = element_text(size = 12, color="black")) +
  theme(axis.title.y = element_text(size = 14, face = "bold")) +
  theme(axis.title.x = element_text(size = 14, face = "bold"))
f6a
```

Avg_DStrArea_perCapita
```{r Define simple power function, include=FALSE,echo=F,message=FALSE,warning=FALSE,results = 'hide'}
pwrfunc <- function(MedRingDist, b1, b2) {
  b1 * MedRingDist^b2
}
pwr_nls_fit <- nls.multstart::nls_multstart(Avg_DStrArea_perCapita ~ pwrfunc(MedRingDist, b1, b2),
                             data = TeoRings,
                             start_lower = c(b1=1, b2=-2),
                             start_upper = c(b1=500, b2=0),
                             iter = 500,
                             supp_errors = "Y")

pp6 = ModelPredFrame(pwr_nls_fit,TeoRings,"MedRingDist","Avg_DStrArea_perCapita")

```

```{r  message=FALSE,warning=FALSE}
pwr_nls_fit_results = RegressionResultsTab(pwr_nls_fit, TeoRings, TeoRings$MedRingDist, TeoRings$Avg_DStrArea_perCapita, model_type="nls", coef="both", residplots=TRUE, residhists=TRUE)
pwr_nls_fit_results[[1]]
pwr_nls_fit_results[[2]]
pwr_nls_fit_results[[3]]
```


```{r echo=FALSE,message=FALSE,warning=FALSE}

f6a <- ggplot() +
  geom_errorbarh(data = TeoRings, aes(x = MedRingDist, y = Avg_DStrArea_perCapita, xmin = MinRingDist, xmax = MaxRingDist, label=Ring),height=0.75, size=1) +
  geom_point(data = TeoRings, aes(x = MedRingDist, y = Avg_DStrArea_perCapita), size=2.5, color="black", shape=16, stroke =2)+
  geom_line(data = pp6, aes(x=MedRingDist, y=Avg_DStrArea_perCapita.p), inetype = "solid", color="tan3", size=1.3) +
  annotate("label", x = 2500, y = 60, label = "Avg. Domestic Structure Area per capita", color ="tan3", size=5)+
  annotate("label", x = 2500, y = 55, label = "atop(bold(italic(PctDStrArea_pc) == 197.4 ~italic(Dist) ^ -0.206),bold(italic(pseudo~R^2) == 0.953 ~~~~~~ italic(n) == 9 ))", parse = TRUE, color ="tan3", size=4)+
  
  xlab("Distance from Center (km)") +
  ylab("Avg DStr Area per capita (m^2/ppl)      ") +
  theme_bw() +
  
  #scale_y_continuous(breaks=seq(0.06,0.18,0.04),) +
  scale_x_continuous(expand = c(0, 0), limits=c(-20,4600),breaks=seq(0,4000,1000),
                     labels=function(x)x/1000) +
  #scale_y_continuous(expand = c(0, 0), ,) +
  #scale_x_continuous(expand = c(0, 0), limits=c(-20,4600),breaks=seq(0,4000,1000)) +
  theme(plot.title = element_text(size = 14, face = "bold",hjust = 0.5)) +
  theme(plot.subtitle = element_text(size = 12, face = "bold.italic",hjust = 0.5)) +
  theme(axis.text = element_text(size = 12, color="black")) +
  theme(axis.title.y = element_text(size = 12, face = "bold")) +
  theme(axis.title.x = element_text(size = 14, face = "bold"))

f6a
```








```{r}
Fig6 <- plot_grid(f6a, f6b, labels = "AUTO", label_size = 30, hjust=0)#f6c, f6d,


Fig6


ggsave("Fig6.png", plot = Fig6, device = "png", path = wd$figs, scale = 1, width = 10, height = 4,   units = "in",  dpi = 1000, bg = "white")






rm(f6a, f6b, Fig6)
```


st_as_sf


```{r}

areas = data.frame("Ring"= TeoRings$Ring, "MedRingDist"= TeoRings$MedRingDist, "DomStruct" = (TeoRings$Area_DStr+TeoRings$DomPlat_Area), "CCFeat" = TeoRings$CCFeat_O_Area, "Open" = TeoRings$Area_OpenUnoccu)
areas = areas %>% pivot_longer(3:5, names_to = "Land_Use", values_to = "Area") %>%
  group_by(Ring, Land_Use) %>%
  summarise(n = sum(Area)) %>%
  mutate(percentage = n / sum(n))
LandUse <- factor(areas$Land_Use, levels = c('Open', 'CCFeat', 'DomStruct'))

f4a2 <- ggplot(areas, aes(x=Ring, y=percentage, fill=LandUse)) + 
    geom_area(alpha=0.6 , size=1, colour="black",stat="identity")+
  scale_fill_manual(name="Land Use Classes", values = c("yellowgreen","blue","firebrick"),
                    labels=c("Open/Unoccupied", "CC Features", "Domestic Structures"))+
xlab("Concentric Ring") +
  ylab("% Ring Area") +
  theme_bw() +
  scale_y_continuous(labels = scales::percent) +#, limits=c(0,1)expand = c(0, 0), limits=c(0,90),breaks=seq(0,90,10)
  scale_x_continuous(expand = c(0, 0), limits=c(1,9),breaks=seq(1,9,1)) +
  theme(legend.position = c(0.65, 0.65))+
  theme(legend.title = element_text(size=14, face="bold"))+
  theme(legend.text = element_text(size=12, face="bold"))+
  theme(axis.text = element_text(size = 12, color="black")) +
  theme(axis.title.y = element_text(size = 14, face = "bold")) +
  theme(axis.title.x = element_text(size = 14, face = "bold"))
f4a2
```

```{r echo=FALSE,message=FALSE,warning=FALSE}
Dareas = data.frame("MedRingDist"= TeoRings$MedRingDist,
                    "MinRingDist"= TeoRings$MinRingDist,
                    "MaxRingDist"= TeoRings$MaxRingDist,
                    "Total" = TeoRings$Med_Area_DStr / 10000,
                   "High" = TeoRings$Med_Elite_DStrArea, 
                   "Intermediate" = TeoRings$Med_IM_DStrArea, 
                   "Uncertain" = TeoRings$Med_UncerStat_DStrArea,
                   "Low" = TeoRings$Med_Low_DStrArea *10
                   )
Dareas[5:9,5] <- NA
Dareas[8:9,7] <- NA
Dareas[1,7] <- NA
Dareas = Dareas %>% pivot_longer(4:8, names_to = "Status2", values_to = "MedDStrArea") 

Class3 <- factor(Dareas$Status2, levels = c('Total', 'High','Intermediate','Uncertain', 'Low'))#'',


f6b <- ggplot() +
  #geom_errorbarh(data = Dareas, aes(x = MedRingDist, y = AvgDStrArea, xmin = MinRingDist, xmax = MaxRingDist),height=0.75, size=1) +
  geom_line(data = Dareas, aes(x = MedRingDist, y = MedDStrArea, color=Class3), size=1.5)+
  scale_color_manual(name = "Median DStr Area", values = c("black","green2","gold","darkorange", "red"), labels=c('Total', 'High','Intermediate','Uncertain', 'Low x 10'))+#"orange2",
  geom_point(data = Dareas, aes(x = MedRingDist, y = MedDStrArea), size=1.5, color="black", shape=16, stroke =2)+
  xlab("Distance from Center (km)") +
  ylab("Median DStr Area (m^2)") +
  theme_bw() +
  scale_y_continuous(expand = c(0, 0), limits=c(0,3000),breaks=seq(0,3000,1000)) +#, limits=c(0.3,1), breaks=seq(0.4,1,0.2)
  scale_x_continuous(expand = c(0, 0), limits=c(0,4600),breaks=seq(0,4000,1000),labels=function(x)x/1000) +
  theme(legend.position = c(0.6, 0.775))+
  theme(legend.title = element_text(size=12, face="bold"))+
  theme(legend.text = element_text(size=10, face="bold"))+
  theme(legend.spacing.y = unit(0.3, 'cm'))+
  theme(legend.key = element_rect(colour = "transparent", fill = "transparent"))+
  theme(legend.background = element_rect(fill="transparent", colour = "transparent"))+
  theme(axis.text = element_text(size = 12, color="black")) +
  theme(axis.title.y = element_text(size = 14, face = "bold")) +
  theme(axis.title.x = element_text(size = 14, face = "bold"))
f6b
```



```{r echo=FALSE,message=FALSE,warning=FALSE}
gini = data.frame("MedRingDist"= TeoRings$MedRingDist,
                    "MinRingDist"= TeoRings$MinRingDist,
                    "MaxRingDist"= TeoRings$MaxRingDist,
                    "Total" = TeoRings$DStrArea_Gini_TOT,
                   "High" = TeoRings$DStrArea_Gini_High, 
                   "Intermediate" = TeoRings$DStrArea_Gini_IM, 
                   "Uncertain" = TeoRings$DStrArea_Gini_U#,
                   #"Low" = TeoRings$PctCol_Tot_LowDStrArea
                   )
gini[8:9,7] <- NA
gini = gini %>% pivot_longer(4:7, names_to = "Status2", values_to = "GiniDStrArea") 

Class4 <- factor(gini$Status2, levels = c('Total', 'High','Intermediate','Uncertain'))#'',


f6c <- ggplot() +
  geom_line(data = gini, aes(x = MedRingDist, y = GiniDStrArea, color=Class4), size=1.5)+
  scale_color_manual(name = "Gini DStr Area", values = c("black","green2","gold","darkorange"))+#"orange2",
  geom_point(data = gini, aes(x = MedRingDist, y = GiniDStrArea), size=1.5, color="black", shape=16, stroke =2)+
  xlab("Distance from Center (km)") +
  ylab("Gini Index of DStr Area") +
  theme_bw() +
  scale_y_continuous(expand = c(0, 0), limits=c(0.1,1),breaks=seq(0.1,0.9,0.2)) +#, limits=c(0.3,1), breaks=seq(0.4,1,0.2)
  scale_x_continuous(expand = c(0, 0), limits=c(0,4600),breaks=seq(0,4000,1000),labels=function(x)x/1000) +
  theme(legend.position = c(0.25, 0.75))+
  theme(legend.title = element_text(size=12, face="bold"))+
  theme(legend.text = element_text(size=10, face="bold"))+
  theme(legend.spacing.y = unit(0.3, 'cm'))+
  theme(legend.key = element_rect(colour = "transparent", fill = "transparent"))+
  theme(legend.background = element_rect(fill="transparent", colour = "transparent"))+
  theme(axis.text = element_text(size = 12, color="black")) +
  theme(axis.title.y = element_text(size = 14, face = "bold")) +
  theme(axis.title.x = element_text(size = 14, face = "bold"))
f6c
```

```{r echo=FALSE,message=FALSE,warning=FALSE}

f5d <- ggplot(data = TeoRings, aes(x = PctRow_Area_RuralOpen, y = PctRow_Ring_DStr_Low)) +
  geom_point(size=2.5, color="black", shape=16, stroke =2)+
  geom_smooth(method = lm, se = FALSE,color="red", size=1.3)+
  annotate("label", x = 0.225, y = 0.605, label = "atop(bold(italic(PctLow) == 0.85 * ~italic(PctCCFeat) + 0.109),bold(italic(R^2) == 0.919 ~~~~~~ italic(n) == 9 ))", parse = TRUE, color ="red3", size=4)+
  annotate("label", x = 0.225, y = 0.695, label = "Low Status", color ="red", size=5)+
  xlab("Rural Open % Ring Area") +
  ylab("% Ring DStr") +
  theme_bw() +
  scale_y_continuous(labels = scales::percent) +#, limits=c(0.3,1), breaks=seq(0.4,1,0.2)
  scale_x_continuous(labels = scales::percent) +#, limits=c(0,0.25), breaks=seq(0,0.25,0.05)
  theme(plot.title = element_text(size = 14, face = "bold",hjust = 0.5)) +
  theme(plot.subtitle = element_text(size = 12, face = "bold.italic",hjust = 0.5)) +
  theme(axis.text = element_text(size = 12, color="black")) +
  theme(axis.title.y = element_text(size = 14, face = "bold")) +
  theme(axis.title.x = element_text(size = 14, face = "bold"))
f5d
```

```{r Define simple power function, include=FALSE,echo=F,message=FALSE,warning=FALSE,results = 'hide'}
explinfunc <- function(PctRow_Area_Open, b1, b2) {
  exp((b1*PctRow_Area_Open)+b2)
}
```

```{r include=FALSE,echo=F,message=FALSE,warning=FALSE,results = 'hide'}
#Estimate the model
explin_nls_fit <- nls.multstart::nls_multstart(PctRow_Ring_DStrArea_Low ~ explinfunc(PctRow_Area_Open, b1, b2),
                             data = TeoRings,
                             start_lower = c(b1=1, b2=-15),
                             start_upper = c(b1=10, b2=1),
                             iter = 500,
                             supp_errors = "Y")

pp3 = ModelPredFrame(explin_nls_fit,TeoRings,"PctRow_Area_Open","PctRow_Ring_DStrArea_Low")

```


### Full Regression Results

*"Robust" coef estimates estimated using covariance matrices corrected for heteroskedasticity and autocorrelation*

```{r echo=FALSE,message=FALSE,warning=FALSE}

explin_nls_fit_results = RegressionResultsTab(explin_nls_fit, TeoRings, TeoRings$PctRow_Area_Open, TeoRings$PctRow_Ring_DStrArea_Low, model_type="nls", coef="both", residplots=TRUE, residhists=TRUE)

explin_nls_fit_results[[1]]
explin_nls_fit_results[[2]]
explin_nls_fit_results[[3]]
```

```{r echo=FALSE,message=FALSE,warning=FALSE}

f5d <- ggplot() +
  geom_point(data = TeoRings, aes(x = PctRow_Area_Open, y = PctRow_Ring_DStrArea_Low), size=2.5, color="black", shape=16, stroke =2)+
  geom_line(data = pp3, aes(x=PctRow_Area_Open, y=PctRow_Ring_DStrArea_Low.p), inetype = "solid", color="red", size=1.3) +
  annotate("label", x = 0.6, y = 0.06, label = "atop(bold(italic(PctLow) == italic(e) ^ (16.4 * ~italic(PctOpen) - 18.8)),bold(italic(pseudo~R^2) == 0.877 ~~~~~~ italic(n) == 9 ))", parse = TRUE, color ="black", size=4)+
  xlab("Open % Ring Area") +
  ylab("Low Status % Ring DStr Area   ") +
  theme_bw() +
  scale_y_continuous(labels = scales::percent, limits=c(0,0.08)) +#, breaks=seq(0.4,1,0.2)
  scale_x_continuous(labels = scales::percent) +#, limits=c(0,0.25), breaks=seq(0,0.25,0.05)
  #scale_y_continuous(expand = c(0, 0), ,) +
  #scale_x_continuous(expand = c(0, 0), limits=c(-20,4600),breaks=seq(0,4000,1000)) +
  theme(plot.title = element_text(size = 14, face = "bold",hjust = 0.5)) +
  theme(plot.subtitle = element_text(size = 12, face = "bold.italic",hjust = 0.5)) +
  theme(axis.text = element_text(size = 12, color="black")) +
  theme(axis.title.y = element_text(size = 14, face = "bold")) +
  theme(axis.title.x = element_text(size = 14, face = "bold"))
f5d
```


```{r echo=FALSE,message=FALSE,warning=FALSE}

f5d <- ggplot() +
  geom_point(data = TeoRings, aes(x = PctRow_Area_RuralOpen, y = PctRow_Ring_DStrArea_Low), size=2.5, color="black", shape=16, stroke =2)+
  geom_line(data = pp3, aes(x=PctRow_Area_Open, y=PctRow_Ring_DStrArea_Low.p), inetype = "solid", color="red", size=1.3) +
  annotate("label", x = 0.6, y = 0.06, label = "atop(bold(italic(PctLow) == italic(e) ^ (16.4 * ~italic(PctOpen) - 18.8)),bold(italic(pseudo~R^2) == 0.877 ~~~~~~ italic(n) == 9 ))", parse = TRUE, color ="black", size=4)+
  xlab("Open % Ring Area") +
  ylab("Low Status % Ring DStr Area   ") +
  theme_bw() +
  scale_y_continuous(labels = scales::percent, limits=c(0,0.08)) +#, breaks=seq(0.4,1,0.2)
  scale_x_continuous(labels = scales::percent) +#, limits=c(0,0.25), breaks=seq(0,0.25,0.05)
  #scale_y_continuous(expand = c(0, 0), ,) +
  #scale_x_continuous(expand = c(0, 0), limits=c(-20,4600),breaks=seq(0,4000,1000)) +
  theme(plot.title = element_text(size = 14, face = "bold",hjust = 0.5)) +
  theme(plot.subtitle = element_text(size = 12, face = "bold.italic",hjust = 0.5)) +
  theme(axis.text = element_text(size = 12, color="black")) +
  theme(axis.title.y = element_text(size = 14, face = "bold")) +
  theme(axis.title.x = element_text(size = 14, face = "bold"))
f5d
```




```{r echo=FALSE,message=FALSE,warning=FALSE}
areas2 = data.frame("MedRingDist"= TeoRings$MedRingDist,
                   "High" = TeoRings$PctCol_DStrArea_Elite, 
                   "Intermediate" = TeoRings$PctCol_DStrArea_IM, 
                   #"Uncertain" = TeoRings$PctCol_DStrArea_UncerStat,
                   "Low" = TeoRings$PctCol_Tot_LowDStrArea)
areas2 = areas2 %>% pivot_longer(2:4, names_to = "Status2", values_to = "Percent") 

Class2 <- factor(areas2$Status2, levels = c('High','Intermediate','Low'))#'Uncertain',


f5b <- ggplot() +
  geom_line(data = areas2, aes(x = MedRingDist, y = Percent, color=Class2), size=1.5)+
  scale_color_manual(name = "Class Status", values = c("green2","gold","red"))+#"orange2",
  geom_point(data = areas2, aes(x = MedRingDist, y = Percent), size=1.5, color="black", shape=16, stroke =2)+
  xlab("Distance from Center (km)") +
  ylab("% of Total DStr Area") +
  theme_bw() +
  scale_y_continuous(labels = scales::percent) +#, limits=c(0.3,1), breaks=seq(0.4,1,0.2)
  scale_x_continuous(expand = c(0, 0), limits=c(0,4600),breaks=seq(0,4000,1000),
                     labels=function(x)x/1000) +
  theme(legend.position = c(0.75, 0.65))+
  theme(legend.title = element_text(size=14, face="bold"))+
  theme(legend.text = element_text(size=12, face="bold"))+
  theme(axis.text = element_text(size = 12, color="black")) +
  theme(axis.title.y = element_text(size = 14, face = "bold")) +
  theme(axis.title.x = element_text(size = 14, face = "bold"))
f5b
```


```{r echo=FALSE,message=FALSE,warning=FALSE}

f4c <- ggplot() +
  geom_errorbarh(data = TeoRings, aes(x = MedRingDist, y = PctRow_Area_Open, xmin = MinRingDist, xmax = MaxRingDist, label=Ring),height=0.01, size=1) +
  geom_line(data = TeoRings, aes(x=MedRingDist, y=PctRow_Area_Open), inetype = "solid", color="orange2", size=1.3) +
  geom_point(data = TeoRings, aes(x = MedRingDist, y = PctRow_Area_Open, xmin = MinRingDist, xmax = MaxRingDist, label=Ring), size=2.5, color="black", shape=16, stroke =2)+
  geom_errorbarh(data = TeoRings, aes(x = MedRingDist, y = PctRow_Area_CCFeat_AoD, xmin = MinRingDist, xmax = MaxRingDist, label=Ring),height=0.01, size=1) +
  geom_line(data = TeoRings, aes(x=MedRingDist, y=PctRow_Area_CCFeat_AoD), inetype = "solid", color="blue", size=1.3) +
  geom_point(data = TeoRings, aes(x = MedRingDist, y = PctRow_Area_CCFeat_AoD, xmin = MinRingDist, xmax = MaxRingDist, label=Ring), size=2.5, color="black", shape=16, stroke =2)+
  annotate("label", x = 3000, y = 0.7, label = "% Open Area", color ="orange2", size=7)+
  annotate("label", x = 3000, y = 0.25, label = "% CC Feature Area", color ="blue", size=7)+
  xlab("Distance from Center (meters)") +
  ylab("Percent Area in Ring") +#Open
  theme_bw() +
  scale_y_continuous(labels = scales::percent) +
  scale_x_continuous(expand = c(0, 0), limits=c(-20,4600),breaks=seq(0,4000,1000)) +
  theme(plot.title = element_text(size = 14, face = "bold",hjust = 0.5)) +
  theme(plot.subtitle = element_text(size = 12, face = "bold.italic",hjust = 0.5)) +
  theme(axis.text = element_text(size = 12, color="black")) +
  theme(axis.title.y = element_text(size = 14, face = "bold")) +
  theme(axis.title.x = element_text(size = 14, face = "bold"))
f4c
```



```{r echo=FALSE,message=FALSE,warning=FALSE}

f4d <- ggplot() +
  geom_errorbarh(data = TeoRings, aes(x = MedRingDist, y = PctRow_Area_Open, xmin = MinRingDist, xmax = MaxRingDist, label=Ring),height=0.01, size=1) +
  geom_line(data = TeoRings, aes(x=MedRingDist, y=PctRow_Area_Open), inetype = "solid", color="yellowgreen", size=1.3) +
  geom_point(data = TeoRings, aes(x = MedRingDist, y = PctRow_Area_Open, xmin = MinRingDist, xmax = MaxRingDist, label=Ring), size=2.5, color="black", shape=16, stroke =2)+
  
  xlab("Distance from Center (meters)") +
  ylab("Open % of Ring Area") +
  theme_bw() +
  scale_y_continuous(labels = scales::percent, limits=c(0.3,1), breaks=seq(0.4,1,0.2)) +
  scale_x_continuous(expand = c(0, 0), limits=c(-20,4600),breaks=seq(0,4000,1000)) +
  theme(plot.title = element_text(size = 14, face = "bold",hjust = 0.5)) +
  theme(plot.subtitle = element_text(size = 12, face = "bold.italic",hjust = 0.5)) +
  theme(axis.text = element_text(size = 12, color="black")) +
  theme(axis.title.y = element_text(size = 14, face = "bold")) +
  theme(axis.title.x = element_text(size = 14, face = "bold"))
f4d
```


```{r Define simple power function, include=FALSE,echo=F,message=FALSE,warning=FALSE,results = 'hide'}
pwrfunc <- function(PctRow_Area_CCFeat_AoD, b1, b2) {
  b1 * PctRow_Area_CCFeat_AoD^b2
}
```

```{r include=FALSE,echo=F,message=FALSE,warning=FALSE,results = 'hide'}
#Estimate the model
pwr_nls_fit <- nls.multstart::nls_multstart(PctRow_Area_Open ~ pwrfunc(PctRow_Area_CCFeat_AoD, b1, b2),
                             data = TeoRings,
                             start_lower = c(b1=-1, b2=-1),
                             start_upper = c(b1=1, b2=1),
                             iter = 500,
                             supp_errors = "Y")

pp2 = ModelPredFrame(pwr_nls_fit,TeoRings,"PctRow_Area_CCFeat_AoD","PctRow_Area_Open")

```


### Full Regression Results

*"Robust" coef estimates estimated using covariance matrices corrected for heteroskedasticity and autocorrelation*

```{r echo=FALSE,message=FALSE,warning=FALSE}

pwr_nls_fit_results = RegressionResultsTab(pwr_nls_fit, TeoRings, TeoRings$PctRow_Area_CCFeat_AoD, TeoRings$PctRow_Area_Open, model_type="nls", coef="both", residplots=TRUE, residhists=TRUE)

pwr_nls_fit_results[[1]]
pwr_nls_fit_results[[2]]
pwr_nls_fit_results[[3]]
```

```{r echo=FALSE,message=FALSE,warning=FALSE}

f4f <- ggplot() +
  geom_point(data = TeoRings, aes(x = PctRow_Area_CCFeat_AoD, y = PctRow_Area_Open), size=2.5, color="black", shape=16, stroke =2)+
  
  geom_line(data = pp2, aes(x=PctRow_Area_CCFeat_AoD, y=PctRow_Area_Open.p), inetype = "solid", color="gold2", size=1.3) +
  #geom_text_repel(data = TeoRings, aes(x = MedRingDist, y = Popdens_TOT, xmin = MinRingDist, xmax = MaxRingDist, label=Ring), size=4,direction="y", fontface="bold", nudge_y=2, point.size=5) +#box.padding=1, 
  #geom_text_repel(box.padding=1,size=5,fontface="bold", nudge_y=1.5) +# 


  #geom_point(data = TeoRings %>% filter(Ring > 1), aes(x = MedRingDist, y = Popdens_TOT, xmin = MinRingDist, xmax = MaxRingDist, label=Ring), size=2.5, color="black", shape=16, stroke =2)+
  #geom_point(data = TeoRings %>% filter(Ring < 2), aes(x = MedRingDist, y = Popdens_TOT), size=3, color="red2", shape=4, stroke =2)+
  annotate("label", x = 0.15, y = 0.8, label = "atop(bold(italic(PctOpen) == 0.914 * ~italic(PctCCFeat) ^ (-5.388)),bold(italic(pseudo~R^2) == 0.771 ~~~~~~ italic(n) == 9 ))", parse = TRUE, color ="black", size=4)+
  #ggtitle("Total Population Density Gradient for 500-meter Concentric Rings", subtitle= "Teotihuacan, Xolalpan-Metepec Phase (c. AD 350-600)") +
  xlab("Percent CC Feature Area in Ring") +
  ylab("Percent Open Area in Ring") +
  theme_bw() +
  scale_y_continuous(labels = scales::percent, limits=c(0.3,1), breaks=seq(0.4,1,0.2)) +
  scale_x_continuous(labels = scales::percent, limits=c(0,0.25), breaks=seq(0,0.25,0.05)) +
  #scale_y_continuous(expand = c(0, 0), ,) +
  #scale_x_continuous(expand = c(0, 0), limits=c(-20,4600),breaks=seq(0,4000,1000)) +
  theme(plot.title = element_text(size = 14, face = "bold",hjust = 0.5)) +
  theme(plot.subtitle = element_text(size = 12, face = "bold.italic",hjust = 0.5)) +
  theme(axis.text = element_text(size = 12, color="black")) +
  theme(axis.title.y = element_text(size = 14, face = "bold")) +
  theme(axis.title.x = element_text(size = 14, face = "bold"))
f4f
```
CCFeat_AoD_Area
Area_Open





```{r}
plot_grid(
  f4a, f4b, f4c, f4e#,
  #labels = "AUTO", ncol = 2, label_size = 30,
  #label_x = 1, label_y = 1
)
```

```{r}
plot_grid(
  f4a, f4b, 
  labels = "AUTO", ncol = 2, label_size = 30
  #label_x = 1, label_y = 1
)
```




```{r}
plot_grid(
  f4a, f4b, f4c, f4d#,
  #labels = "AUTO", ncol = 2, label_size = 30
  #label_x = 1, label_y = 1
)
```


TeoRings[-1,]

ModelPredFrame
RegressionResultsTab





Combine rings 8 and 9? 
Ring 8 is small and Ring 9 is really small
Constitute outliers in several analyses

In the standard AMM model, an increase in transport costs leads to 
--nucleation
--densification
Sharper increases in 
--prices of land/houses
--building height
--pop density
Sharper decreases in
-dwelling sizes























writeOGR(Teo_ArchPoly_Data, paste0(wd$data_f,"Teo_ArchPoly_Data.gpkg"), "Teo_ArchPoly_Data", driver = "GPKG", overwrite_layer=TRUE)





















